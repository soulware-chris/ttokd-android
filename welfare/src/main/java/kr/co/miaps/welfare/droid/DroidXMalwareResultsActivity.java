package kr.co.miaps.welfare.droid;

import android.app.Activity;
import android.content.Intent;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.text.Html;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.CompoundButton;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import net.nshc.droidx3.engine.ScanResult;
import net.nshc.droidx3.manager.apk.DroidXApkManager;

import java.io.File;
import java.util.ArrayList;

import kr.co.miaps.welfare.R;
import kr.co.miaps.welfare.droid.list.DroidXServiceListAdapter;

public class DroidXMalwareResultsActivity extends Activity implements OnClickListener {
	private TextView tvScanResult = null;
	private CheckBox allCheckBox = null;
	private ListView lvMalwareList = null;
	private Button btnCancel = null;
	private Button btnDel = null;
	
	private int iTotalSize = 0;
	private ArrayList<String> mKeyList = null;
	private ArrayList<String> mVList = null;
	private ArrayList<ScanResult> mSCList = null;
	private ArrayList<String> applist = null;
	
	public static final int DX_REQUEST_CODE = 0x01;
	private int uninstallAppsCurrentCount = 0;
	private int uninstallAppsTotalCount = 0;
	
	private DroidXServiceListAdapter<String> arradapter = null;
	
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_malware_list);
		
		Intent mIntent = getIntent();
		
		setUI();
		setData(mIntent);
		
		arradapter = new DroidXServiceListAdapter<String>(this, R.layout.activity_malware_row_list, mVList);
		lvMalwareList.setAdapter(arradapter);
		lvMalwareList.setFastScrollEnabled(true);
	}
	
	private void setUI() {
		tvScanResult = (TextView)findViewById(R.id.tv_scanresult_bar_summary);
		allCheckBox = (CheckBox)findViewById(R.id.cb_scanresult_bar_all_check);
		allCheckBox.setOnCheckedChangeListener(new OnCheckedChangeListener() {
			@Override
			public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
				if(arradapter != null) {
					arradapter.setAllChecked(isChecked);
					arradapter.notifyDataSetChanged();
				}
			}
		});
		lvMalwareList = (ListView)findViewById(R.id.lview_detail_scanresult_vlist);
		btnCancel = (Button)findViewById(R.id.btn_scanresult_cancel);
		btnDel = (Button)findViewById(R.id.btn_scanresult_remove_file);
		btnCancel.setOnClickListener(this);
		btnDel.setOnClickListener(this);
	}
	
	private void setData(Intent mIntent) {
		Bundle mBundle = mIntent.getBundleExtra("DX_Malwares");
		if(mKeyList == null) mKeyList = new ArrayList<String>();
		if(mVList == null) mVList = new ArrayList<String>();
		if(mSCList == null) mSCList = new ArrayList<ScanResult>();
		
		int count = 1;
		for(String key : mBundle.keySet()) {
			ScanResult sr = (ScanResult) mBundle.get(key);
			if (sr.getResultCode() != 1) continue;
			String line = "["+Integer.toString(count++)+"]\n";
			line +=  "Package: "+sr.getPackageName()+"\nType: "+  "MAL"
					+"\nDesc: "+sr.getDescription()+"\nPath: "+sr.getTargetPath();
			
			mKeyList.add(key);
			mSCList.add(sr);
			mVList.add(line);
		}
		
		iTotalSize = mIntent.getIntExtra("DX_TotalSize", 0);
		tvScanResult.setText(Html.fromHtml("검사 수:"+"<b>"+iTotalSize+"</b>&nbsp;&nbsp;"+"발견 수:"+"<font color='red'><b>"+mVList.size()+"</b></font>"));
	}

	@Override
	public void onClick(View v) {
		switch (v.getId()) {
		// 취소를 선택하였을 때
		case R.id.btn_scanresult_cancel:
			malwareCheck();
			break;
		// 삭제를 선택하였을 때
		case R.id.btn_scanresult_remove_file:
			applist = new ArrayList<String>();
			ArrayList<String> filelist = new ArrayList<String>();
			for(int i=0; i<arradapter.getCount(); i++) {
				if(arradapter.getChecked(i)) {
					
					if(mKeyList.get(i).startsWith("/data/app/")) { // 설치된 앱일 경우
						applist.add(mSCList.get(i).getPackageName());
					} else { // 기타 나머지의 경우
						filelist.add(mKeyList.get(i));
					}
				}
			}
			
			if(filelist.size() + applist.size() < 1 ) {
				Toast.makeText(this, "하나 이상의 악성앱을 선택해야 합니다.", Toast.LENGTH_SHORT).show();
				break;
			}
			
			if(filelist.size() > 0) {
				if(!removeFiles(filelist)) {
					Toast.makeText(this, "파일을 삭제하는데 문제가 있습니다.", Toast.LENGTH_SHORT).show();
				} else {
					Toast.makeText(this, "선택하신 파일을 삭제하였습니다.", Toast.LENGTH_SHORT).show();
					if(applist.size() == 0) {
						malwareCheck();
					}
				}
			}
			if(applist.size() > 0) {
				removeApps(applist);
			}
			
			break;
		default:
			break;
		}
	}
	
	private boolean removeFiles(ArrayList<String> arrlistFilepath) {
		if (Build.VERSION.SDK_INT < 30) {
			for (String sFilepath : arrlistFilepath) {
				File mFile = new File(sFilepath);
				if (mFile.exists()) {
					mFile.delete();
					if (mFile.exists()) return false;
				}
			}
		}
		return true;
	}

	private boolean removeApps(ArrayList<String> arrlistPackagename) {
		uninstallAppsTotalCount = arrlistPackagename.size();
		uninstallAppsCurrentCount = 0;
		
		removeApp();
		return true;
	}
	
	private void removeApp() {
		Intent mIntent = new Intent(Intent.ACTION_DELETE);
		Uri mUri = Uri.fromParts("package", applist.get(uninstallAppsCurrentCount), null);
		mIntent.setData(mUri);
		startActivityForResult(mIntent, DX_REQUEST_CODE);
		uninstallAppsCurrentCount++;
	}
	
	// 삭제 후 결과를 받는 함수
	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		if(requestCode == DX_REQUEST_CODE) {
			if(uninstallAppsCurrentCount < uninstallAppsTotalCount) {	
				removeApp();
			} else {
				malwareCheck();
			}
		}
		super.onActivityResult(requestCode, resultCode, data);
	}
	
	@Override
	public void onBackPressed() {
		stopApp();
	}

	private void malwareCheck() {
		stopApp();
	}

	private void stopApp() {
		Toast.makeText(getApplicationContext(), "앱을 종료 합니다.", Toast.LENGTH_SHORT).show();
		DroidXApkManager.getInstance().stopService();
		finish();
		android.os.Process.killProcess(android.os.Process.myPid());
	}
}
